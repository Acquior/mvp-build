<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Small Business Dashboard</title>
    <link rel="stylesheet" href="small-business-styles.css">
    <script src="https://cdn.ethers.io/lib/ethers-5.0.umd.min.js"></script>
    <script>
        let contract;
        let signer;
        const contractAddress = '0xe4d5De9eb7b059d6AC206a021aCa3967975658d9';
        const contractABI = [
            "function createInvoice(address recipient, uint256 amount) public returns (uint256)",
            "function payInvoice(uint256 tokenId) public payable",
            "function listInvoiceForSale(uint256 tokenId, uint256 salePrice) public",
            "function buyInvoice(uint256 tokenId) public payable",
            "function getInvoiceDetails(uint256 tokenId) public view returns (uint256, address, address, bool, bool, uint256)",
            "event InvoiceCreated(uint256 indexed tokenId, uint256 amount, address indexed issuer, address indexed recipient)"
        ];

        const polygonAmoyChainId = '80002'; // Polygon Amoy testnet chain ID

        async function connectWallet() {
    if (typeof window.ethereum !== 'undefined') {
        try {
            await switchToPolygonAmoy();
            await ethereum.request({ method: 'eth_requestAccounts' });
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            contract = new ethers.Contract(contractAddress, contractABI, signer);

            const address = await signer.getAddress();
            document.querySelector('.connect-wallet').textContent = `Connected: ${address.slice(0, 6)}...${address.slice(-4)}`;

            console.log('Wallet connected');
            if (await verifyContractConnection()) {
                console.log('Contract connection verified');
                await fetchInvoices();
            } else {
                updateStatusMessage('Error connecting to the contract. Please check console for details.');
            }
        } catch (error) {
            console.error('Failed to connect wallet:', error);
            updateStatusMessage('Failed to connect wallet. Please try again.');
        }
    } else {
        alert('Please install MetaMask!');
    }
}
        

        async function switchToPolygonAmoy() {
    const polygonAmoyChainId = '0x13881'; // 80002 in hexadecimal
    try {
        await ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: polygonAmoyChainId }],
        });
    } catch (switchError) {
        // This error code indicates that the chain has not been added to MetaMask.
        if (switchError.code === 4902) {
            try {
                await ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: polygonAmoyChainId,
                        chainName: 'Polygon Amoy Testnet',
                        nativeCurrency: {
                            name: 'MATIC',
                            symbol: 'MATIC',
                            decimals: 18
                        },
                        rpcUrls: ['https://rpc-amoy.polygon.technology/'],
                        blockExplorerUrls: ['https://www.oklink.com/amoy']
                    }],
                });
            } catch (addError) {
                console.error('Failed to add Polygon Amoy network:', addError);
            }
        }
        console.error('Failed to switch to Polygon Amoy network:', switchError);
    }
}

        async function verifyContractConnection() {
            if (!contract) {
                console.error('Contract is not initialized');
                return false;
            }
            
            try {
                console.log('Contract address:', contract.address);
                console.log('Contract ABI:', JSON.stringify(contractABI));
                return true;
            } catch (error) {
                console.error('Error verifying contract connection:', error);
                return false;
            }
        }

        async function fetchInvoices() {
    if (!contract) {
        console.error('Contract is not initialized');
        updateStatusMessage('Error: Contract not initialized. Please connect your wallet.');
        return;
    }

    const invoiceList = document.querySelector('.invoice-list');
    invoiceList.innerHTML = '<h2>Your Invoices</h2>';
    updateStatusMessage('Fetching invoices...');

    try {
        const address = await signer.getAddress();
        let tokenId = 0;
        let consecutiveErrors = 0;
        const maxConsecutiveErrors = 5;

        while (consecutiveErrors < maxConsecutiveErrors) {
            try {
                const invoice = await contract.getInvoiceDetails(tokenId);
                if (invoice[1] === address) { // Check if the current user is the issuer
                    const card = createInvoiceCard(tokenId, invoice[0], invoice[3], invoice[4], invoice[5]);
                    invoiceList.appendChild(card);
                    consecutiveErrors = 0;
                }
                tokenId++;
            } catch (error) {
                console.error(`Error fetching invoice ${tokenId}:`, error);
                consecutiveErrors++;
            }
        }

        if (invoiceList.children.length === 1) {
            updateStatusMessage('No invoices found for the current user.');
        } else {
            updateStatusMessage('Invoices fetched successfully.');
        }
    } catch (error) {
        console.error('Error fetching invoices:', error);
        updateStatusMessage('Error fetching invoices. Please try again.');
    }
}

async function updateSmallBusinessDashboard(currentAddress) {
    const table = document.getElementById('smallBusinessTable');
    table.innerHTML = '<tr><th>Token ID</th><th>Amount</th><th>Recipient</th><th>Paid</th><th>For Sale</th><th>Sale Price</th><th>Action</th></tr>';

    let tokenId = 0;
    let consecutiveErrors = 0;
    const maxConsecutiveErrors = 5;

    while (consecutiveErrors < maxConsecutiveErrors) {
        const invoice = await fetchInvoiceDetails(tokenId);
        if (invoice) {
            // Process and display invoice
            consecutiveErrors = 0;
        } else {
            consecutiveErrors++;
        }
        tokenId++;
    }

    if (table.rows.length === 1) {
        console.log("No invoices found for the current user");
    }
}
        async function createInvoice(event) {
    event.preventDefault();
    const recipient = document.getElementById('recipient-address').value;
    const amountMatic = document.getElementById('amount-matic').value;
    const amountWei = ethers.utils.parseEther(amountMatic);

    try {
        updateStatusMessage('Creating invoice... Please wait.');
        const tx = await contract.createInvoice(recipient, amountWei);
        console.log('Transaction sent:', tx.hash);
        const receipt = await tx.wait();
        console.log('Invoice created:', receipt);
        updateStatusMessage('Invoice created successfully!');
        await fetchInvoices();
    } catch (error) {
        console.error('Error creating invoice:', error);
        updateStatusMessage('Error creating invoice. Please try again.');
    }
}

        function updateStatusMessage(message) {
            document.querySelector('.status-message').textContent = message;
        }

        function createInvoiceCard(tokenId, amount, paid, forSale, salePrice) {
    const card = document.createElement('div');
    card.className = 'invoice-card';
    card.innerHTML = `
        <p><strong>Token ID:</strong> ${tokenId}</p>
        <p><strong>Amount:</strong> ${ethers.utils.formatEther(amount)} MATIC</p>
        <p><strong>Status:</strong> ${paid ? 'Paid' : 'Unpaid'}</p>
        <p><strong>For Sale:</strong> ${forSale ? 'Yes' : 'No'}</p>
        ${forSale ? `<p><strong>Sale Price:</strong> ${ethers.utils.formatEther(salePrice)} MATIC</p>` : ''}
        ${!paid && !forSale ? `<button class="list-sale-btn" onclick="listForSale(${tokenId})">List for Sale</button>` : ''}
    `;
    return card;
}

        async function listForSale(tokenId) {
            const salePrice = prompt("Enter the sale price in Rands:");
            if (salePrice === null) return;

            const salePriceWei = ethers.utils.parseEther(salePrice);
            try {
                const tx = await contract.listInvoiceForSale(tokenId, salePriceWei);
                updateStatusMessage('Listing invoice for sale... Please wait.');
                await tx.wait();
                updateStatusMessage('Invoice listed for sale successfully!');
                await fetchInvoices();
            } catch (error) {
                console.error('Error listing invoice for sale:', error);
                updateStatusMessage('Error listing invoice for sale. Please try again.');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('.connect-wallet').addEventListener('click', connectWallet);
        });
    </script>
</head>
<body>
    <header>
        <div class="logo">
            <img src="logo.png" alt="Acquior Technology Logo">
        </div>
        <button class="connect-wallet">Connect Wallet</button>
    </header>
    <main>
        <h1>Create Invoice</h1>
        <form id="invoice-form" onsubmit="createInvoice(event)">
            <label for="recipient-address">Recipient Address</label>
            <input type="text" id="recipient-address" placeholder="Enter recipient address" required>
            <label for="amount-rands">Amount in Rands</label>
            <input type="number" id="amount-rands" placeholder="Enter amount in Rands" required>
            <button type="submit" class="create-invoice-btn">Create Invoice</button>
        </form>
        <div class="status-message">
            Status messages and error notifications will appear here.
        </div>
        
        <section class="invoice-list">
            <h2>Your Invoices</h2>
            <!-- Invoices will be dynamically added here -->
        </section>
    </main>
    <footer>
        <nav class="footer-nav">
            <a href="index.html" class="nav-icon">Home</a>
            <a href="#" class="nav-icon">Invoices</a>
            <a href="#" class="nav-icon">Menu</a>
        </nav>
    </footer>
</body>
</html>

