<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Small Business Dashboard</title>
    <link rel="stylesheet" href="small-business-styles.css">
    <script src="https://cdn.ethers.io/lib/ethers-5.0.umd.min.js"></script>
    <script>
        let contract;
        let signer;

        const contractAddress = '0x830CC57aA0A99dc7F8C3154f7c5F58cED390aAbe';
        const contractABI = [
            "function createInvoice(address recipient, uint256 amount) public returns (uint256)",
            "function payInvoice(uint256 tokenId) public payable",
            "function isInvoicePaid(uint256 tokenId) public view returns (bool)",
            "function listInvoiceForSale(uint256 tokenId, uint256 salePrice) public",
            "function buyInvoice(uint256 tokenId) public payable",
            "function invoices(uint256 tokenId) public view returns (uint256, address, address, bool, bool, uint256)",
            "event InvoiceCreated(uint256 indexed tokenId, uint256 amount, address indexed issuer, address indexed recipient)",
            "event InvoiceListedForSale(uint256 indexed tokenId, uint256 salePrice)",
            "event InvoiceSold(uint256 indexed tokenId, address indexed buyer, uint256 price)"
        ];

        const ETH_TO_RAND = 1000000; // 1 ETH = 1,000,000 Rand

        async function getGasPrice() {
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const gasPrice = await provider.getGasPrice();
    return gasPrice.mul(120).div(100); // 20% buffer
}
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if (pageId !== 'home' && contract) {
                updateDashboards();
            }
        }

        function ethToRand(ethAmount) {
            return ethers.utils.formatEther(ethAmount) * ETH_TO_RAND;
        }

        function randToEth(randAmount) {
            return ethers.utils.parseEther((randAmount / ETH_TO_RAND).toString());
        }

        function formatRand(amount) {
            return new Intl.NumberFormat('en-ZA', { style: 'currency', currency: 'ZAR' }).format(amount);
        }

        async function checkNetwork() {
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const network = await provider.getNetwork();
    if (network.chainId !== 80002) { // Amoy chain ID
        alert('Please switch to Polygon Amoy Testnet in MetaMask');
        return false;
    }
    return true;
}

        async function connectWallet() {
            clearLogAndReset();
            if (typeof window.ethereum !== 'undefined') {
                try {
                    await ethereum.request({ method: 'eth_requestAccounts' });
                    if (await checkNetwork()) {
                        const provider = new ethers.providers.Web3Provider(window.ethereum);
                        signer = provider.getSigner();
                        contract = new ethers.Contract(contractAddress, contractABI, signer);
                        document.getElementById('status').textContent = 'Connected';
                        console.log('Connected to Sepolia');
                        setupEventListeners();
                        updateDashboards();
                    }
                } catch (error) {
                    console.error('Failed to connect wallet:', error);
                    document.getElementById('status').textContent = 'Connection failed';
                }
            } else {
                alert('Please install MetaMask');
                document.getElementById('status').textContent = 'MetaMask not detected';
            }
        }

        function setupEventListeners() {
            contract.on("InvoiceCreated", (tokenId, amount, issuer, recipient) => {
                console.log('Invoice created:', { tokenId: tokenId.toString(), amount: ethToRand(amount), issuer, recipient });
                updateDashboards();
            });

            contract.on("InvoiceListedForSale", (tokenId, salePrice) => {
                console.log('Invoice listed for sale:', { tokenId: tokenId.toString(), salePrice: ethToRand(salePrice) });
                updateDashboards();
            });

            contract.on("InvoiceSold", (tokenId, buyer, price) => {
                console.log('Invoice sold:', { tokenId: tokenId.toString(), buyer, price: ethToRand(price) });
                updateDashboards();
            });
        }

        async function updateDashboards() {
            const currentAddress = await signer.getAddress();
            updateSmallBusinessDashboard(currentAddress);
            updateInvestorDashboard(currentAddress);
            updateBigBusinessDashboard(currentAddress);
        }

        async function updateSmallBusinessDashboard(currentAddress) {
            const table = document.getElementById('smallBusinessTable');
            table.innerHTML = '<tr><th>Token ID</th><th>Amount</th><th>Recipient</th><th>Paid</th><th>For Sale</th><th>Sale Price</th><th>Action</th></tr>';

            const addedTokens = new Set();

            for (let i = 0; i < 100; i++) {
                try {
                    const invoice = await contract.invoices(i);
                    if (invoice[1] === currentAddress && !addedTokens.has(i)) {
                        addedTokens.add(i);
                        const row = table.insertRow(-1);
                        row.insertCell(0).textContent = i;
                        row.insertCell(1).textContent = formatRand(ethToRand(invoice[0]));
                        row.insertCell(2).textContent = truncateAddress(invoice[2]);
                        row.insertCell(3).textContent = invoice[3] ? "Yes" : "No";
                        row.insertCell(4).textContent = invoice[4] ? "Yes" : "No";
                        row.insertCell(5).textContent = formatRand(ethToRand(invoice[5]));
                        
                        const actionCell = row.insertCell(6);
                        if (!invoice[3] && !invoice[4]) {
                            const listButton = document.createElement('button');
                            listButton.textContent = "List for Sale";
                            listButton.onclick = () => listInvoiceForSale(i);
                            actionCell.appendChild(listButton);
                        }
                    }
                } catch (error) {
                    console.error(`Error fetching invoice ${i}:`, error);
                    break;
                }
            }
        }

        async function updateInvestorDashboard(currentAddress) {
            const table = document.getElementById('investorTable');
            table.innerHTML = '<tr><th>Token ID</th><th>Amount</th><th>Issuer</th><th>Sale Price</th><th>Action</th></tr>';

            for (let i = 0; i < 100; i++) {
                try {
                    const invoice = await contract.invoices(i);
                    if (invoice[4] && invoice[1] !== currentAddress) {
                        const row = table.insertRow(-1);
                        row.insertCell(0).textContent = i;
                        row.insertCell(1).textContent = formatRand(ethToRand(invoice[0]));
                        row.insertCell(2).textContent = truncateAddress(invoice[1]);
                        row.insertCell(3).textContent = formatRand(ethToRand(invoice[5]));
                        
                        const actionCell = row.insertCell(4);
                        const buyButton = document.createElement('button');
                        buyButton.textContent = "Buy";
                        buyButton.onclick = () => buyInvoice(i, invoice[5]);
                        actionCell.appendChild(buyButton);
                    }
                } catch (error) {
                    break;
                }
            }
        }

        async function updateBigBusinessDashboard(currentAddress) {
            const table = document.getElementById('bigBusinessTable');
            table.innerHTML = '<tr><th>Token ID</th><th>Amount</th><th>Issuer</th><th>Paid</th><th>Action</th></tr>';

            for (let i = 0; i < 100; i++) {
                try {
                    const invoice = await contract.invoices(i);
                    if (invoice[2] === currentAddress) {
                        const row = table.insertRow(-1);
                        row.insertCell(0).textContent = i;
                        row.insertCell(1).textContent = formatRand(ethToRand(invoice[0]));
                        row.insertCell(2).textContent = truncateAddress(invoice[1]);
                        row.insertCell(3).textContent = invoice[3] ? "Yes" : "No";
                        
                        const actionCell = row.insertCell(4);
                        if (!invoice[3]) {
                            const payButton = document.createElement('button');
                            payButton.textContent = "Pay";
                            payButton.onclick = () => payInvoice(i, invoice[0]);
                            actionCell.appendChild(payButton);
                        }
                    }
                } catch (error) {
                    break;
                }
            }
        }

        async function getGasPrice() {
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const gasPrice = await provider.getGasPrice();
    return gasPrice.mul(120).div(100); // 20% buffer
}

async function createInvoice() {
    try {
        const recipient = document.getElementById('recipient').value;
        const amount = ethers.utils.parseEther(document.getElementById('amount').value);
        
        console.log('Sending createInvoice transaction on Amoy...');
        const gasPrice = await getGasPrice();
        const tx = await contract.createInvoice(recipient, amount, { gasPrice });
        console.log('Transaction sent, waiting for confirmation...');
        const receipt = await tx.wait();
        console.log('Transaction confirmed on Amoy:', receipt);

        const event = receipt.events.find(e => e.event === 'InvoiceCreated');
        if (event) {
            const [tokenId, amount, issuer, recipient] = event.args;
            updateUIAfterInvoiceCreation(tokenId, amount, issuer, recipient);
        } else {
            document.getElementById('result').textContent = `Invoice created on Amoy. Transaction hash: ${receipt.transactionHash}`;
        }
    } catch (error) {
        console.error('Error creating invoice on Amoy:', error);
        document.getElementById('result').textContent = 'Failed to create invoice on Amoy. See console for details.';
    }
}

async function payInvoice() {
    try {
        const tokenId = document.getElementById('payTokenId').value;
        const amount = ethers.utils.parseEther(document.getElementById('payAmount').value);
        console.log(`Attempting to pay invoice on Amoy. Token ID: ${tokenId}, Amount: ${ethers.utils.formatEther(amount)} MATIC`);
        
        const gasPrice = await getGasPrice();
        const estimatedGas = await contract.estimateGas.payInvoice(tokenId, { value: amount });
        const gasLimit = estimatedGas.mul(120).div(100); // 20% buffer
        
        const tx = await contract.payInvoice(tokenId, { 
            value: amount,
            gasPrice: gasPrice,
            gasLimit: gasLimit
        });
        console.log('Transaction sent, waiting for confirmation...');
        const receipt = await tx.wait();
        console.log('Invoice paid successfully on Amoy', receipt);
        document.getElementById('result').textContent = 'Invoice paid successfully on Amoy!';
    } catch (error) {
        console.error('Error paying invoice on Amoy:', error);
        document.getElementById('result').textContent = `Failed to pay invoice on Amoy: ${error.message}`;
    }
}

async function listInvoiceForSale() {
    try {
        const tokenId = document.getElementById('listTokenId').value;
        const salePrice = ethers.utils.parseEther(document.getElementById('salePrice').value);
        
        console.log(`Attempting to list invoice for sale on Amoy. Token ID: ${tokenId}, Sale Price: ${ethers.utils.formatEther(salePrice)} MATIC`);

        const gasPrice = await getGasPrice();
        const tx = await contract.listInvoiceForSale(tokenId, salePrice, { gasPrice });
        console.log('Transaction sent, waiting for confirmation...');
        const receipt = await tx.wait();
        console.log('Invoice listed for sale successfully on Amoy', receipt);
        document.getElementById('result').textContent = 'Invoice listed for sale successfully on Amoy!';
    } catch (error) {
        console.error('Error listing invoice for sale on Amoy:', error);
        let errorMessage = 'Failed to list invoice for sale on Amoy';
        if (error.message.includes("Only the owner can list the invoice for sale")) {
            errorMessage = "You are not the owner of this invoice";
        } else if (error.message.includes("Paid invoices cannot be sold")) {
            errorMessage = "This invoice has already been paid and cannot be sold";
        } else if (error.message.includes("Invoice is already listed for sale")) {
            errorMessage = "This invoice is already listed for sale";
        } else if (error.message.includes("Sale price must be greater than zero")) {
            errorMessage = "The sale price must be greater than zero";
        }
        document.getElementById('result').textContent = errorMessage;
    }
}

async function buyInvoice() {
    try {
        const tokenId = document.getElementById('buyTokenId').value;
        const amount = ethers.utils.parseEther(document.getElementById('buyAmount').value);
        console.log(`Attempting to buy invoice on Amoy. Token ID: ${tokenId}, Price: ${ethers.utils.formatEther(amount)} MATIC`);
        
        const gasPrice = await getGasPrice();
        const tx = await contract.buyInvoice(tokenId, { value: amount, gasPrice });
        console.log('Transaction sent, waiting for confirmation...');
        const receipt = await tx.wait();
        console.log('Invoice bought successfully on Amoy', receipt);
        document.getElementById('result').textContent = 'Invoice bought successfully on Amoy!';
    } catch (error) {
        console.error('Error buying invoice on Amoy:', error);
        document.getElementById('result').textContent = `Failed to buy invoice on Amoy: ${error.message}`;
    }
}

function truncateAddress(address) {
    return `${address.slice(0, 6)}...${address.slice(-4)}`;
}

function clearLogAndReset() {
    console.clear();
    console.log('Logs cleared and UI reset');

    document.getElementById('status').textContent = 'Not connected';
    document.getElementById('small-business-result').textContent = '';
    document.getElementById('big-business-result').textContent = '';
    document.getElementById('investor-result').textContent = '';

    document.getElementById('smallBusinessTable').innerHTML = '<tr><th>Token ID</th><th>Amount</th><th>Recipient</th><th>Paid</th><th>For Sale</th><th>Sale Price</th><th>Action</th></tr>';
    document.getElementById('bigBusinessTable').innerHTML = '<tr><th>Token ID</th><th>Amount</th><th>Issuer</th><th>Paid</th><th>Action</th></tr>';
    document.getElementById('investorTable').innerHTML = '<tr><th>Token ID</th><th>Amount</th><th>Issuer</th><th>Sale Price</th><th>Action</th></tr>';

    contract = null;
    signer = null;
}

window.addEventListener('load', clearLogAndReset);
    </script>
</head>
<body>
    <header>
        <div class="logo">
            <img src="logo.png" alt="Acquior Technology Logo">
        </div>
        <button class="menu-btn">
            <div class="menu-icon"></div>
        </button>
    </header>

    <main>
        <section class="invoice-form">
            <h1>Create Invoice</h1>
            <form id="invoice-form">
                <label for="recipient-address">Recipient Address</label>
                <input type="text" id="recipient-address" placeholder="">

                <label for="amount-rands">Amount in Rands</label>
                <input type="number" id="amount-rands" placeholder="138">

                <button type="submit" class="create-invoice-btn">Create Invoice</button>
            </form>
            <div class="status-message">
                Status messages and error notifications will appear here.
            </div>
        </section>

        <section class="invoice-list">
            <h2>Your Invoices</h2>
            <div class="invoice-card">
                <p><strong>Token ID:</strong> 123456</p>
                <p><strong>Amount:</strong> R500</p>
                <p><strong>Status:</strong> Unpaid</p>
                <button class="list-sale-btn">List for Sale</button>
            </div>
        </section>
    </main>

    <footer>
        <nav class="footer-nav">
            <a href="#" class="nav-icon">
                <img src="home-icon.png" alt="Home">
            </a>
            <a href="#" class="nav-icon">
                <img src="invoice-icon.png" alt="Invoices">
            </a>
            <a href="#" class="nav-icon">
                <img src="menu-icon.png" alt="Menu">
            </a>
        </nav>
    </footer>
</body>
</html>
