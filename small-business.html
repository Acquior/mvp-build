<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Martech Fin - Small Business</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.ethers.io/lib/ethers-5.0.umd.min.js"></script>
    <script>
        let contract;
        let signer;
        const contractAddress = '0x830CC57aA0A99dc7F8C3154f7c5F58cED390aAbe';
        const contractABI = [
            "function createInvoice(address recipient, uint256 amount) public returns (uint256)",
            "function payInvoice(uint256 tokenId) public payable",
            "function listInvoiceForSale(uint256 tokenId, uint256 salePrice) public",
            "function buyInvoice(uint256 tokenId) public payable",
            "event InvoiceCreated(uint256 indexed tokenId, uint256 amount, address indexed issuer, address indexed recipient)"
        ];

        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    await ethereum.request({ method: 'eth_requestAccounts' });
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    contract = new ethers.Contract(contractAddress, contractABI, signer);
                    
                    const address = await signer.getAddress();
                    document.querySelector('.connect-wallet').textContent = `Connected: ${address.slice(0, 6)}...${address.slice(-4)}`;
                    
                    console.log('Wallet connected');
                    fetchInvoices();
                } catch (error) {
                    console.error('Failed to connect wallet:', error);
                }
            } else {
                alert('Please install MetaMask!');
            }
        }

        async function createInvoice(event) {
            event.preventDefault();
            const recipient = document.getElementById('recipient-address').value;
            const amount = ethers.utils.parseEther(document.getElementById('amount-rands').value);

            try {
                const tx = await contract.createInvoice(recipient, amount);
                await tx.wait();
                console.log('Invoice created');
                document.querySelector('.status-message').textContent = 'Invoice created successfully!';
                fetchInvoices();
            } catch (error) {
                console.error('Error creating invoice:', error);
                document.querySelector('.status-message').textContent = 'Error creating invoice. Please try again.';
            }
        }

        async function fetchInvoices() {
            const invoicesContainer = document.querySelector('.invoice-list');
            invoicesContainer.innerHTML = '<h2>Your Invoices</h2>';
            
            try {
                const userAddress = await signer.getAddress();
                let tokenId = 0;

                while (tokenId < 100) {
                    try {
                        const [amount, issuer, recipient, paid, forSale, salePrice] = await contract.invoices(tokenId);
                        if (issuer.toLowerCase() === userAddress.toLowerCase()) {
                            const invoiceElement = document.createElement('div');
                            invoiceElement.className = 'invoice-card';
                            invoiceElement.innerHTML = `
                                <p><strong>Token ID:</strong> ${tokenId}</p>
                                <p><strong>Amount:</strong> R${ethers.utils.formatEther(amount)}</p>
                                <p><strong>Status:</strong> ${paid ? 'Paid' : 'Unpaid'}</p>
                            `;
                            invoicesContainer.appendChild(invoiceElement);
                        }
                        tokenId++;
                    } catch (error) {
                        break;
                    }
                }
            } catch (error) {
                console.error('Error fetching invoices:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('.connect-wallet').addEventListener('click', connectWallet);
            document.getElementById('invoice-form').addEventListener('submit', createInvoice);
        });
    </script>
</head>
<body>
    <header>
        <div class="logo">
            <img src="logo.png" alt="Acquior Technology Logo">
        </div>
        <button class="connect-wallet">Connect Wallet</button>
    </header>
    <main>
        <section class="invoice-form">
            <h1>Create Invoice</h1>
            <form id="invoice-form">
                <input type="text" id="recipient-address" placeholder="Recipient Address" required>
                <input type="number" id="amount-rands" placeholder="Amount in Rands" required>
                <button type="submit">Create Invoice</button>
            </form>
            <div class="status-message"></div>
        </section>
        <section class="invoice-list">
            <h2>Your Invoices</h2>
            <!-- Invoices will be dynamically added here -->
        </section>
    </main>
    <footer>
        <a href="index.html">Home</a>
        <a href="#">About</a>
        <a href="#">Contact</a>
    </footer>
</body>
</html>
