<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Martech Fin MVP</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.0.umd.min.js"></script>
    <script>
        let contract;
        let signer;

        const contractAddress = '0x830CC57aA0A99dc7F8C3154f7c5F58cED390aAbe'; // Replace with your actual contract address
        const contractABI = [
            "function createInvoice(address recipient, uint256 amount) public returns (uint256)",
            "function payInvoice(uint256 tokenId) public payable",
            "function listInvoiceForSale(uint256 tokenId, uint256 salePrice) public",
            "function buyInvoice(uint256 tokenId) public payable",
            "event InvoiceCreated(uint256 indexed tokenId, address recipient, uint256 amount)"
        ];

        async function checkNetwork() {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const network = await provider.getNetwork();
            if (network.chainId !== 11155111) { // Sepolia chain ID
                alert('Please switch to Sepolia Test Network in MetaMask');
                return false;
            }
            return true;
        }

        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    await ethereum.request({ method: 'eth_requestAccounts' });
                    if (await checkNetwork()) {
                        const provider = new ethers.providers.Web3Provider(window.ethereum);
                        signer = provider.getSigner();
                        contract = new ethers.Contract(contractAddress, contractABI, signer);
                        document.getElementById('status').textContent = 'Connected';
                        console.log('Connected to Sepolia');
                    }
                } catch (error) {
                    console.error('Failed to connect wallet:', error);
                    document.getElementById('status').textContent = 'Connection failed';
                }
            } else {
                alert('Please install MetaMask');
                document.getElementById('status').textContent = 'MetaMask not detected';
            }
        }

        async function createInvoice() {
    try {
        const recipient = document.getElementById('recipient').value;
        const amount = ethers.utils.parseEther(document.getElementById('amount').value);
        
        // Set up event listener before sending the transaction
        contract.once("InvoiceCreated", (tokenId, recipient, amount, event) => {
            console.log('Invoice created event received:', { tokenId, recipient, amount });
            document.getElementById('lastCreatedTokenId').textContent = tokenId.toString();
            document.getElementById('result').textContent = `Invoice created successfully! Token ID: ${tokenId}`;
            
            // Add the new invoice to the list
            const invoicesList = document.getElementById('invoicesList');
            const listItem = document.createElement('li');
            listItem.textContent = `Token ID: ${tokenId}, Recipient: ${recipient}, Amount: ${ethers.utils.formatEther(amount)} ETH`;
            invoicesList.appendChild(listItem);
        });

        const tx = await contract.createInvoice(recipient, amount);
        await tx.wait();
        
        console.log('Transaction confirmed');
    } catch (error) {
        console.error('Error creating invoice:', error);
        document.getElementById('result').textContent = 'Failed to create invoice. See console for details.';
    }
}

        async function payInvoice() {
            try {
                const tokenId = document.getElementById('payTokenId').value;
                const amount = ethers.utils.parseEther(document.getElementById('payAmount').value);
                const tx = await contract.payInvoice(tokenId, { value: amount });
                await tx.wait();
                console.log('Invoice paid successfully');
                document.getElementById('result').textContent = 'Invoice paid successfully!';
            } catch (error) {
                console.error('Error paying invoice:', error);
                document.getElementById('result').textContent = 'Failed to pay invoice. See console for details.';
            }
        }

        async function listInvoiceForSale() {
            try {
                const tokenId = document.getElementById('listTokenId').value;
                const salePrice = ethers.utils.parseEther(document.getElementById('salePrice').value);
                const tx = await contract.listInvoiceForSale(tokenId, salePrice);
                await tx.wait();
                console.log('Invoice listed for sale successfully');
                document.getElementById('result').textContent = 'Invoice listed for sale successfully!';
            } catch (error) {
                console.error('Error listing invoice for sale:', error);
                document.getElementById('result').textContent = 'Failed to list invoice for sale. See console for details.';
            }
        }

        async function buyInvoice() {
            try {
                const tokenId = document.getElementById('buyTokenId').value;
                const amount = ethers.utils.parseEther(document.getElementById('buyAmount').value);
                const tx = await contract.buyInvoice(tokenId, { value: amount });
                await tx.wait();
                console.log('Invoice bought successfully');
                document.getElementById('result').textContent = 'Invoice bought successfully!';
            } catch (error) {
                console.error('Error buying invoice:', error);
                document.getElementById('result').textContent = 'Failed to buy invoice. See console for details.';
            }
        }
    </script>
</head>
<body>
    <h1>Martech Fin MVP</h1>
    <button onclick="connectWallet()">Connect Wallet</button>
    <p>Status: <span id="status">Not connected</span></p>

    <h2>Create Invoice</h2>
    <input id="recipient" type="text" placeholder="Recipient address">
    <input id="amount" type="text" placeholder="Amount in ETH">
    <button onclick="createInvoice()">Create Invoice</button>
    <p>Last Created Token ID: <span id="lastCreatedTokenId"></span></p>

    <h2>Pay Invoice</h2>
    <input id="payTokenId" type="number" placeholder="Token ID">
    <input id="payAmount" type="text" placeholder="Amount in ETH">
    <button onclick="payInvoice()">Pay Invoice</button>

    <h2>List Invoice for Sale</h2>
    <input id="listTokenId" type="number" placeholder="Token ID">
    <input id="salePrice" type="text" placeholder="Sale Price in ETH">
    <button onclick="listInvoiceForSale()">List for Sale</button>

    <h2>Buy Invoice</h2>
    <input id="buyTokenId" type="number" placeholder="Token ID">
    <input id="buyAmount" type="text" placeholder="Amount in ETH">
    <button onclick="buyInvoice()">Buy Invoice</button>

    <p id="result"></p>

    <h2>Created Invoices</h2>
    <ul id="invoicesList"></ul>
</body>
</html>
