<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Martech Fin - Invoice Tokenization Platform</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.0.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: #4CAF50;
            color: white;
            text-align: center;
            padding: 1rem;
        }
        nav {
            background-color: #333;
            color: white;
            padding: 0.5rem;
        }
        nav ul {
            list-style-type: none;
            padding: 0;
        }
        nav ul li {
            display: inline;
            margin-right: 10px;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
        }
        .container {
            padding: 20px;
        }
        .page {
            display: none;
        }
        .active {
            display: block;
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
        }
        input[type=text], input[type=number] {
            width: 100%;
            padding: 12px 20px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .result {
            background-color: #f2f2f2;
            padding: 20px;
            margin-top: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <header>
        <h1>Martech Fin - Invoice Tokenization Platform</h1>
    </header>
    <nav>
        <ul>
            <li><a href="#" onclick="showPage('home')">Home</a></li>
            <li><a href="#" onclick="showPage('small-business')">Small Business</a></li>
            <li><a href="#" onclick="showPage('big-business')">Big Business</a></li>
            <li><a href="#" onclick="showPage('investor')">Investor</a></li>
        </ul>
    </nav>
    <div class="container">
        <div id="home" class="page active">
            <h2>Welcome to Martech Fin</h2>
            <p>Connect your wallet to get started:</p>
            <button onclick="connectWallet()">Connect Wallet</button>
            <p>Status: <span id="status">Not connected</span></p>
        </div>
        <div id="small-business" class="page">
            <h2>Small Business Dashboard</h2>
            <h3>Create Invoice</h3>
            <input id="recipient" type="text" placeholder="Recipient address">
            <input id="amount" type="text" placeholder="Amount in ETH">
            <button onclick="createInvoice()">Create Invoice</button>
            <div id="small-business-result" class="result"></div>
            <h3>Your Invoices</h3>
            <table id="smallBusinessTable"></table>
        </div>
        <div id="big-business" class="page">
            <h2>Big Business Dashboard</h2>
            <h3>Invoices to Pay</h3>
            <table id="bigBusinessTable"></table>
            <div id="big-business-result" class="result"></div>
        </div>
        <div id="investor" class="page">
            <h2>Investor Dashboard</h2>
            <h3>Invoices Available for Purchase</h3>
            <table id="investorTable"></table>
            <div id="investor-result" class="result"></div>
        </div>
    </div>
    <script>
        let contract;
        let signer;

        const contractAddress = '0x15D1aF7d327035b70367062621F2ECED718910BE';
        const contractABI = [
            "function createInvoice(address recipient, uint256 amount) public returns (uint256)",
            "function payInvoice(uint256 tokenId) public payable",
            "function isInvoicePaid(uint256 tokenId) public view returns (bool)",
            "function listInvoiceForSale(uint256 tokenId, uint256 salePrice) public",
            "function buyInvoice(uint256 tokenId) public payable",
            "function invoices(uint256 tokenId) public view returns (uint256, address, address, bool, bool, uint256)",
            "event InvoiceCreated(uint256 indexed tokenId, uint256 amount, address indexed issuer, address indexed recipient)",
            "event InvoiceListedForSale(uint256 indexed tokenId, uint256 salePrice)",
            "event InvoiceSold(uint256 indexed tokenId, address indexed buyer, uint256 price)"
        ];

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if (pageId !== 'home' && contract) {
                updateDashboards();
            }
        }

        async function checkNetwork() {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const network = await provider.getNetwork();
            if (network.chainId !== 11155111) {
                alert('Please switch to Sepolia Test Network in MetaMask');
                return false;
            }
            return true;
        }

        async function connectWallet() {
    if (typeof window.ethereum !== 'undefined') {
        try {
            await ethereum.request({ method: 'eth_requestAccounts' });
            if (await checkNetwork()) {
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                
                // Check if the contract is properly initialized
                if (contract && contract.address) {
                    document.getElementById('status').textContent = 'Connected';
                    console.log('Connected to Sepolia');
                    setupEventListeners();
                    updateDashboards();
                    setupAutomaticUpdates();
                } else {
                    throw new Error('Failed to initialize contract');
                }
            }
        } catch (error) {
            console.error('Failed to connect wallet:', error);
            document.getElementById('status').textContent = 'Connection failed: ' + error.message;
        }
    } else {
        alert('Please install MetaMask');
        document.getElementById('status').textContent = 'MetaMask not detected';
    }
}

function setupEventListeners() {
    console.log('Setting up event listeners...');
    console.log('Contract object:', contract);
    
    if (contract && contract.on) {
        contract.on("InvoiceCreated", (tokenId, amount, issuer, recipient) => {
            console.log('Invoice created:', { tokenId: tokenId.toString(), amount: amount.toString(), issuer, recipient });
            updateDashboards();
        });

        contract.on("InvoiceListedForSale", (tokenId, salePrice) => {
            console.log('Invoice listed for sale:', { tokenId: tokenId.toString(), salePrice: salePrice.toString() });
            updateDashboards();
        });

        contract.on("InvoiceSold", (tokenId, buyer, price) => {
            console.log('Invoice sold:', { tokenId: tokenId.toString(), buyer, price: price.toString() });
            updateDashboards();
        });
        
        console.log('Event listeners set up successfully');
    } else {
        console.error('Failed to set up event listeners: contract or contract.on is undefined');
    }
}

        async function updateDashboards() {
            const currentAddress = await signer.getAddress();
            updateSmallBusinessDashboard(currentAddress);
            updateInvestorDashboard(currentAddress);
            updateBigBusinessDashboard(currentAddress);
        }

        async function updateSmallBusinessDashboard(currentAddress) {
            const table = document.getElementById('smallBusinessTable');
            table.innerHTML = '<tr><th>Token ID</th><th>Amount</th><th>Recipient</th><th>Paid</th><th>For Sale</th><th>Sale Price</th><th>Action</th></tr>';

            for (let i = 0; i < 100; i++) {
                try {
                    const invoice = await contract.invoices(i);
                    if (invoice[1] === currentAddress) {
                        const row = table.insertRow(-1);
                        row.insertCell(0).textContent = i;
                        row.insertCell(1).textContent = ethers.utils.formatEther(invoice[0]) + " ETH";
                        row.insertCell(2).textContent = invoice[2];
                        row.insertCell(3).textContent = invoice[3] ? "Yes" : "No";
                        row.insertCell(4).textContent = invoice[4] ? "Yes" : "No";
                        row.insertCell(5).textContent = ethers.utils.formatEther(invoice[5]) + " ETH";
                        
                        const actionCell = row.insertCell(6);
                        if (!invoice[3] && !invoice[4]) {
                            const listButton = document.createElement('button');
                            listButton.textContent = "List for Sale";
                            listButton.onclick = () => listInvoiceForSale(i);
                            actionCell.appendChild(listButton);
                        }
                    }
                } catch (error) {
                    break;
                }
            }
        }

        async function updateInvestorDashboard(currentAddress) {
            const table = document.getElementById('investorTable');
            table.innerHTML = '<tr><th>Token ID</th><th>Amount</th><th>Issuer</th><th>Sale Price</th><th>Action</th></tr>';

            for (let i = 0; i < 100; i++) {
                try {
                    const invoice = await contract.invoices(i);
                    if (invoice[4] && invoice[1] !== currentAddress) {
                        const row = table.insertRow(-1);
                        row.insertCell(0).textContent = i;
                        row.insertCell(1).textContent = ethers.utils.formatEther(invoice[0]) + " ETH";
                        row.insertCell(2).textContent = invoice[1];
                        row.insertCell(3).textContent = ethers.utils.formatEther(invoice[5]) + " ETH";
                        
                        const actionCell = row.insertCell(4);
                        const buyButton = document.createElement('button');
                        buyButton.textContent = "Buy";
                        buyButton.onclick = () => buyInvoice(i, invoice[5]);
                        actionCell.appendChild(buyButton);
                    }
                } catch (error) {
                    break;
                }
            }
        }

        async function updateBigBusinessDashboard(currentAddress) {
            const table = document.getElementById('bigBusinessTable');
            table.innerHTML = '<tr><th>Token ID</th><th>Amount</th><th>Issuer</th><th>Paid</th><th>Action</th></tr>';

            for (let i = 0; i < 100; i++) {
                try {
                    const invoice = await contract.invoices(i);
                    if (invoice[2] === currentAddress) {
                        const row = table.insertRow(-1);
                        row.insertCell(0).textContent = i;
                        row.insertCell(1).textContent = ethers.utils.formatEther(invoice[0]) + " ETH";
                        row.insertCell(2).textContent = invoice[1];
                        row.insertCell(3).textContent = invoice[3] ? "Yes" : "No";
                        
                        const actionCell = row.insertCell(4);
                        if (!invoice[3]) {
                            const payButton = document.createElement('button');
                            payButton.textContent = "Pay";
                            payButton.onclick = () => payInvoice(i, invoice[0]);
                            actionCell.appendChild(payButton);
                        }
                    }
                } catch (error) {
                    break;
                }
            }
        }

        async function createInvoice() {
            try {
                const recipient = document.getElementById('recipient').value;
                const amount = ethers.utils.parseEther(document.getElementById('amount').value);
                
                console.log('Sending createInvoice transaction...');
                const tx = await contract.createInvoice(recipient, amount);
                console.log('Transaction sent, waiting for confirmation...');
                const receipt = await tx.wait();
                console.log('Transaction confirmed:', receipt);

                const event = receipt.events.find(e => e.event === 'InvoiceCreated');
                if (event) {
                    const [tokenId, amount, issuer, recipient] = event.args;
                    document.getElementById('small-business-result').textContent = `Invoice created successfully! Token ID: ${tokenId}`;
                } else {
                    document.getElementById('small-business-result').textContent = `Invoice created. Transaction hash: ${receipt.transactionHash}`;
                }
                updateDashboards();
            } catch (error) {
                console.error('Error creating invoice:', error);
                document.getElementById('small-business-result').textContent = 'Failed to create invoice. See console for details.';
            }
        }

        async function payInvoice(tokenId, amount) {
            try {
                console.log(`Attempting to pay invoice. Token ID: ${tokenId}, Amount: ${ethers.utils.formatEther(amount)} ETH`);
                
                const gasPrice = await signer.getGasPrice();
                console.log(`Current gas price: ${ethers.utils.formatUnits(gasPrice, 'gwei')} gwei`);
                
                const estimatedGas = await contract.estimateGas.payInvoice(tokenId, { value: amount });
                console.log(`Estimated gas limit: ${estimatedGas.toString()}`);
                
                const gasLimit = estimatedGas.mul(120).div(100); // 20% buffer
                
                const tx = await contract.payInvoice(tokenId, { 
                    value: amount,
                    gasLimit: gasLimit
                });
                console.log('Transaction sent, waiting for confirmation...');
                const receipt = await tx.wait();
                console.log('Invoice paid successfully', receipt);
                document.getElementById('big-business-result').textContent = 'Invoice paid successfully!';
                updateDashboards();
            } catch (error) {
                console.error('Error paying invoice:', error);
                document.getElementById('big-business-result').textContent = `Failed to pay invoice: ${error.message}`;
            }
        }
        async function listInvoiceForSale(tokenId) {
            try {
                const salePrice = prompt("Enter the sale price in ETH:");
                if (salePrice === null) return;
                
                const salePriceWei = ethers.utils.parseEther(salePrice);
                console.log(`Attempting to list invoice for sale. Token ID: ${tokenId}, Sale Price: ${salePrice} ETH`);

                const tx = await contract.listInvoiceForSale(tokenId, salePriceWei);
                console.log('Transaction sent, waiting for confirmation...');
                const receipt = await tx.wait();
                console.log('Invoice listed for sale successfully', receipt);
                document.getElementById('small-business-result').textContent = 'Invoice listed for sale successfully!';
                updateDashboards();
            } catch (error) {
                console.error('Error listing invoice for sale:', error);
                let errorMessage = 'Failed to list invoice for sale';
                if (error.message.includes("Only the owner can list the invoice for sale")) {
                    errorMessage = "You are not the owner of this invoice";
                } else if (error.message.includes("Paid invoices cannot be sold")) {
                    errorMessage = "This invoice has already been paid and cannot be sold";
                } else if (error.message.includes("Invoice is already listed for sale")) {
                    errorMessage = "This invoice is already listed for sale";
                } else if (error.message.includes("Sale price must be greater than zero")) {
                    errorMessage = "The sale price must be greater than zero";
                }
                document.getElementById('small-business-result').textContent = errorMessage;
            }
        }

        async function buyInvoice(tokenId, price) {
            try {
                console.log(`Attempting to buy invoice. Token ID: ${tokenId}, Price: ${ethers.utils.formatEther(price)} ETH`);
                const tx = await contract.buyInvoice(tokenId, { value: price });
                console.log('Transaction sent, waiting for confirmation...');
                const receipt = await tx.wait();
                console.log('Invoice bought successfully', receipt);
                document.getElementById('investor-result').textContent = 'Invoice bought successfully!';
                updateDashboards();
            } catch (error) {
                console.error('Error buying invoice:', error);
                document.getElementById('investor-result').textContent = `Failed to buy invoice: ${error.message}`;
            }
        }

        // Add this function to improve user experience
        function truncateAddress(address) {
            return `${address.slice(0, 6)}...${address.slice(-4)}`;
        }

        // Update the updateSmallBusinessDashboard function
async function updateSmallBusinessDashboard(currentAddress) {
    const table = document.getElementById('smallBusinessTable');
    table.innerHTML = '<tr><th>Token ID</th><th>Amount</th><th>Recipient</th><th>Paid</th><th>For Sale</th><th>Sale Price</th><th>Action</th></tr>';

    for (let i = 0; i < 100; i++) {
        try {
            const invoice = await contract.invoices(i);
            if (invoice[1] === currentAddress) {
                const row = table.insertRow(-1);
                row.insertCell(0).textContent = i;
                row.insertCell(1).textContent = ethers.utils.formatEther(invoice[0]) + " ETH";
                row.insertCell(2).textContent = truncateAddress(invoice[2]);
                row.insertCell(3).textContent = invoice[3] ? "Yes" : "No";
                row.insertCell(4).textContent = invoice[4] ? "Yes" : "No";
                row.insertCell(5).textContent = ethers.utils.formatEther(invoice[5]) + " ETH";
                
                const actionCell = row.insertCell(6);
                if (!invoice[3] && !invoice[4]) {
                    const listButton = document.createElement('button');
                    listButton.textContent = "List for Sale";
                    listButton.onclick = () => listInvoiceForSale(i);
                    actionCell.appendChild(listButton);
                }
            }
        } catch (error) {
            break;
        }
    }
}

// Update the updateInvestorDashboard function
async function updateInvestorDashboard(currentAddress) {
    const table = document.getElementById('investorTable');
    table.innerHTML = '<tr><th>Token ID</th><th>Amount</th><th>Issuer</th><th>Sale Price</th><th>Action</th></tr>';

    for (let i = 0; i < 100; i++) {
        try {
            const invoice = await contract.invoices(i);
            if (invoice[4] && invoice[1] !== currentAddress) {
                const row = table.insertRow(-1);
                row.insertCell(0).textContent = i;
                row.insertCell(1).textContent = ethers.utils.formatEther(invoice[0]) + " ETH";
                row.insertCell(2).textContent = truncateAddress(invoice[1]);
                row.insertCell(3).textContent = ethers.utils.formatEther(invoice[5]) + " ETH";
                
                const actionCell = row.insertCell(4);
                const buyButton = document.createElement('button');
                buyButton.textContent = "Buy";
                buyButton.onclick = () => buyInvoice(i, invoice[5]);
                actionCell.appendChild(buyButton);
            }
        } catch (error) {
            break;
        }
    }
}

// Update the updateBigBusinessDashboard function
async function updateBigBusinessDashboard(currentAddress) {
    const table = document.getElementById('bigBusinessTable');
    table.innerHTML = '<tr><th>Token ID</th><th>Amount</th><th>Issuer</th><th>Paid</th><th>Action</th></tr>';

    for (let i = 0; i < 100; i++) {
        try {
            const invoice = await contract.invoices(i);
            if (invoice[2] === currentAddress) {
                const row = table.insertRow(-1);
                row.insertCell(0).textContent = i;
                row.insertCell(1).textContent = ethers.utils.formatEther(invoice[0]) + " ETH";
                row.insertCell(2).textContent = truncateAddress(invoice[1]);
                row.insertCell(3).textContent = invoice[3] ? "Yes" : "No";
                
                const actionCell = row.insertCell(4);
                if (!invoice[3]) {
                    const payButton = document.createElement('button');
                    payButton.textContent = "Pay";
                    payButton.onclick = () => payInvoice(i, invoice[0]);
                    actionCell.appendChild(payButton);
                }
            }
        } catch (error) {
            break;
        }
    }
}

// Update the connectWallet function
async function connectWallet() {
    if (typeof window.ethereum !== 'undefined') {
        try {
            await ethereum.request({ method: 'eth_requestAccounts' });
            if (await checkNetwork()) {
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                document.getElementById('status').textContent = 'Connected';
                console.log('Connected to Sepolia');
                setupEventListeners();
                updateDashboards();
                setupAutomaticUpdates();  // Add this line to set up automatic updates
            }
        } catch (error) {
            console.error('Failed to connect wallet:', error);
            document.getElementById('status').textContent = 'Connection failed';
        }
    } else {
        alert('Please install MetaMask');
        document.getElementById('status').textContent = 'MetaMask not detected';
    }
}
    </script>
</body>
</html>
