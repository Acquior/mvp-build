<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Martech Fin - Invoice Tokenization Platform</title>
    <link rel="stylesheet" href="indexstyles.css">
    <script src="https://cdn.ethers.io/lib/ethers-5.0.umd.min.js"></script>
    <style>
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
        }

        tr {
            background-color: #f8f8f8;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        td {
            padding: 10px 15px;
            text-align: left;
        }

        td strong {
            display: inline-block;
            margin-right: 5px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }

        @media screen and (max-width: 600px) {
            thead {
                display: none;
            }
            
            tr {
                display: flex;
                flex-wrap: wrap;
                margin-bottom: 20px;
            }
            
            td {
                flex: 1 1 100%;
                border-bottom: 1px solid #eee;
            }
            
            td:last-child {
                border-bottom: none;
            }
            
            td strong {
                display: inline-block;
                width: 100px;
                margin-bottom: 5px;
            }
            
            button {
                width: auto;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <img src="logo.png" alt="Acquior Technology Logo">
        </div>
        <button class="connect-wallet" onclick="connectWallet()">Connect Wallet</button>
    </header>

    <main>
        <div id="home" class="page active">
            <a href="#" class="card" onclick="showPage('small-business')">
                <div class="icon">
                    <img src="small-business-icon.png" alt="Small Business Icon">
                </div>
                <div class="content">
                    <h2>Small Business</h2>
                    <p>Empowering small businesses with financial solutions tailored to their needs.</p>
                </div>
            </a>

            <a href="#" class="card" onclick="showPage('investor')">
                <div class="icon">
                    <img src="investor-icon.png" alt="Investor Icon">
                </div>
                <div class="content">
                    <h2>Investor</h2>
                    <p>Comprehensive tools and insights for savvy investors.</p>
                </div>
            </a>

            <a href="#" class="card" onclick="showPage('big-business')">
                <div class="icon">
                    <img src="big-business-icon.png" alt="Big Business Icon">
                </div>
                <div class="content">
                    <h2>Big Business</h2>
                    <p>Robust financial solutions for large enterprises.</p>
                </div>
            </a>
        </div>

        <div id="small-business" class="page">
            <h2>Small Business Dashboard</h2>
            <h3>Create Invoice</h3>
            <form id="invoice-form" onsubmit="createInvoice(event)">
                <input id="recipient" type="text" placeholder="Recipient address">
                <input id="amount" type="number" placeholder="Amount in Rands">
                <button type="submit">Create Invoice</button>
            </form>
            <div id="small-business-result" class="result"></div>
            <h3>Your Invoices</h3>
            <div class="invoice-list">
                <table id="smallBusinessTable"></table>
            </div>
        </div>

        <div id="big-business" class="page">
            <h2>Big Business Dashboard</h2>
            <h3>Invoices to Pay</h3>
            <table id="bigBusinessTable"></table>
            <div id="big-business-result" class="result"></div>
        </div>

        <div id="investor" class="page">
            <h2>Investor Dashboard</h2>
            <h3>Invoices Available for Purchase</h3>
            <table id="investorTable"></table>
            <div id="investor-result" class="result"></div>
        </div>
    </main>

    <footer>
        <nav class="footer-nav">
            <a href="#" onclick="showPage('home')" class="nav-icon">Home</a>
            <a href="#" class="nav-icon">Invoices</a>
            <a href="#" class="nav-icon">Menu</a>
        </nav>
    </footer>

    <script>
        let contract;
        let signer;

        const contractAddress = '0x524b0F673D311C35368eca5FB03957d9701D37AA';
        const contractABI = [
            "function createInvoice(address recipient, uint256 amount) public returns (uint256)",
            "function payInvoice(uint256 tokenId) public payable",
            "function isInvoicePaid(uint256 tokenId) public view returns (bool)",
            "function listInvoiceForSale(uint256 tokenId, uint256 salePrice) public",
            "function buyInvoice(uint256 tokenId) public payable",
            "function invoices(uint256 tokenId) public view returns (uint256, address, address, bool, bool, uint256)",
            "event InvoiceCreated(uint256 indexed tokenId, uint256 amount, address indexed issuer, address indexed recipient)",
            "event InvoiceListedForSale(uint256 indexed tokenId, uint256 salePrice)",
            "event InvoiceSold(uint256 indexed tokenId, address indexed buyer, uint256 price)"
        ];

        const ETH_TO_RAND = 1000000; // 1 ETH = 1,000,000 Rand

        async function getGasPrice() {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const gasPrice = await provider.getGasPrice();
            return gasPrice.mul(120).div(100); // 20% buffer
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if (pageId !== 'home' && contract) {
                updateDashboards();
            }
        }

        function ethToRand(ethAmount) {
            return ethers.utils.formatEther(ethAmount) * ETH_TO_RAND;
        }

        function randToEth(randAmount) {
            return ethers.utils.parseEther((randAmount / ETH_TO_RAND).toString());
        }

        function formatRand(amount) {
            return new Intl.NumberFormat('en-ZA', { style: 'currency', currency: 'ZAR' }).format(amount);
        }

        async function checkNetwork() {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const network = await provider.getNetwork();
            if (network.chainId !== 80002) { // Amoy chain ID
                alert('Please switch to Polygon Amoy Testnet in MetaMask');
                return false;
            }
            return true;
        }

        async function connectWallet() {
            clearLogAndReset();
            if (typeof window.ethereum !== 'undefined') {
                try {
                    await ethereum.request({ method: 'eth_requestAccounts' });
                    if (await checkNetwork()) {
                        const provider = new ethers.providers.Web3Provider(window.ethereum);
                        signer = provider.getSigner();
                        contract = new ethers.Contract(contractAddress, contractABI, signer);
                        const address = await signer.getAddress();
                        document.querySelector('.connect-wallet').textContent = `Connected: ${address.slice(0, 6)}...${address.slice(-4)}`;
                        console.log('Connected to Polygon Amoy');
                        setupEventListeners();
                        updateDashboards();
                    }
                } catch (error) {
                    console.error('Failed to connect wallet:', error);
                    document.getElementById('status').textContent = 'Connection failed';
                }
            } else {
                alert('Please install MetaMask');
                document.getElementById('status').textContent = 'MetaMask not detected';
            }
        }

        function setupEventListeners() {
            contract.on("InvoiceCreated", (tokenId, amount, issuer, recipient) => {
                console.log('Invoice created:', { tokenId: tokenId.toString(), amount: ethToRand(amount), issuer, recipient });
                updateDashboards();
            });

            contract.on("InvoiceListedForSale", (tokenId, salePrice) => {
                console.log('Invoice listed for sale:', { tokenId: tokenId.toString(), salePrice: ethToRand(salePrice) });
                updateDashboards();
            });

            contract.on("InvoiceSold", (tokenId, buyer, price) => {
                console.log('Invoice sold:', { tokenId: tokenId.toString(), buyer, price: ethToRand(price) });
                updateDashboards();
            });
        }

        async function updateDashboards() {
            const currentAddress = await signer.getAddress();
            updateSmallBusinessDashboard(currentAddress);
            updateInvestorDashboard(currentAddress);
            updateBigBusinessDashboard(currentAddress);
        }

        async function updateSmallBusinessDashboard(currentAddress) {
            const table = document.getElementById('smallBusinessTable');
            table.innerHTML = ''; // Remove the header row

            const addedTokens = new Set();

            for (let i = 0; i < 100; i++) {
                try {
                    const invoice = await contract.invoices(i);
                    if (invoice[1] === currentAddress && !addedTokens.has(i)) {
                        addedTokens.add(i);
                        const row = table.insertRow(-1);
                        row.insertCell(0).innerHTML = `<td data-label="Token ID"><strong>Token ID:</strong> ${i}</td>`;
                        row.insertCell(1).innerHTML = `<td data-label="Amount"><strong>Amount:</strong> ${formatRand(ethToRand(invoice[0]))}</td>`;
                        row.insertCell(2).innerHTML = `<td data-label="Recipient"><strong>Recipient:</strong> ${truncateAddress(invoice[2])}</td>`;
                        row.insertCell(3).innerHTML = `<td data-label="Paid"><strong>Paid:</strong> ${invoice[3] ? "Yes" : "No"}</td>`;
                        row.insertCell(4).innerHTML = `<td data-label="For Sale"><strong>For Sale:</strong> ${invoice[4] ? "Yes" : "No"}</td>`;
                        row.insertCell(5).innerHTML = `<td data-label="Sale Price"><strong>Sale Price:</strong> ${formatRand(ethToRand(invoice[5]))}</td>`;
                        
                        const actionCell = row.insertCell(6);
                        actionCell.setAttribute('data-label', 'Action');
                        if (!invoice[3] && !invoice[4]) {
                            const listButton = document.createElement('button');
                            listButton.textContent = "List for Sale";
                            listButton.onclick = () => listInvoiceForSale(i);
                            actionCell.appendChild(listButton);
                        }
                    }
                } catch (error) {
                    console.error(`Error fetching invoice ${i}:`, error);
                    break;
                }
            }
        }

        async function updateInvestorDashboard(currentAddress) {
            const table = document.getElementById('investorTable');
            table.innerHTML = ''; // Remove the header row

            for (let i = 0; i < 100; i++) {
                try {
                    const invoice = await contract.invoices(i);
                    if (invoice[4] && invoice[1] !== currentAddress) {
                        const row = table.insertRow(-1);
                        
                        // Token ID
                        row.insertCell(0).innerHTML = `<td data-label="Token ID"><strong>Token ID:</strong> ${i}</td>`;
                        
                        // Wallet Address (Issuer)
                        row.insertCell(1).innerHTML = `<td data-label="Wallet Address"><strong>Issuer:</strong> ${truncateAddress(invoice[1])}</td>`;
                        
                        // Amount
                        row.insertCell(2).innerHTML = `<td data-label="Amount"><strong>Amount:</strong> ${formatRand(ethToRand(invoice[0]))}</td>`;
                        
                        // Sale Price
                        row.insertCell(3).innerHTML = `<td data-label="Sale Price"><strong>Sale Price:</strong> ${formatRand(ethToRand(invoice[5]))}</td>`;
                        
                        // Buy Button
                        const actionCell = row.insertCell(4);
                        actionCell.setAttribute('data-label', 'Action');
                        const buyButton = document.createElement('button');
                        buyButton.textContent = "Buy";
                        buyButton.onclick = () => buyInvoice(i, invoice[5]);
                        actionCell.appendChild(buyButton);
                        
                        // Apply styling to the button
                        buyButton.style.backgroundColor = '#4CAF50';
                        buyButton.style.color = 'white';
                        buyButton.style.border = 'none';
                        buyButton.style.padding = '5px 10px';
                        buyButton.style.cursor = 'pointer';
                        buyButton.style.borderRadius = '4px';
                        buyButton.style.fontSize = '14px';
                        buyButton.style.width = 'auto';
                    }
                } catch (error) {
                    console.error(`Error fetching invoice ${i}:`, error);
                    break;
                }
            }
        }

        async function updateBigBusinessDashboard(currentAddress) {
            const table = document.getElementById('bigBusinessTable');
            table.innerHTML = ''; // Remove the header row

            for (let i = 0; i < 100; i++) {
                try {
                    const invoice = await contract.invoices(i);
                    if (invoice[2] === currentAddress) {
                        const row = table.insertRow(-1);
                        row.insertCell(0).innerHTML = `<td data-label="Token ID"><strong>Token ID:</strong> ${i}</td>`;
                        row.insertCell(1).innerHTML = `<td data-label="Amount"><strong>Amount:</strong> ${formatRand(ethToRand(invoice[0]))}</td>`;
                        row.insertCell(2).innerHTML = `<td data-label="Issuer"><strong>Issuer:</strong> ${truncateAddress(invoice[1])}</td>`;
                        row.insertCell(3).innerHTML = `<td data-label="Recipient"><strong>Recipient:</strong> ${truncateAddress(invoice[2])}</td>`;
                        row.insertCell(4).innerHTML = `<td data-label="Paid"><strong>Paid:</strong> ${invoice[3] ? "Yes" : "No"}</td>`;
                        row.insertCell(5).innerHTML = `<td data-label="For Sale"><strong>For Sale:</strong> ${invoice[4] ? "Yes" : "No"}</td>`;
                        row.insertCell(6).innerHTML = `<td data-label="Sale Price"><strong>Sale Price:</strong> ${formatRand(ethToRand(invoice[5]))}</td>`;
                        
                        const actionCell = row.insertCell(7);
                        actionCell.setAttribute('data-label', 'Action');
                        if (!invoice[3]) {
                            const payButton = document.createElement('button');
                            payButton.textContent = "Pay";
                            payButton.onclick = () => payInvoice(i, invoice[0]);
                            actionCell.appendChild(payButton);
                        }
                    }
                } catch (error) {
                    console.error(`Error fetching invoice ${i}:`, error);
                    break;
                }
            }
        }

        async function createInvoice(event) {
            event.preventDefault();
            try {
                const recipient = document.getElementById('recipient').value;
                const amount = ethers.utils.parseEther(document.getElementById('amount').value);
                
                console.log('Sending createInvoice transaction on Amoy...');
                const gasPrice = await getGasPrice();
                const tx = await contract.createInvoice(recipient, amount, { gasPrice });
                console.log('Transaction sent, waiting for confirmation...');
                const receipt = await tx.wait();
                console.log('Transaction confirmed on Amoy:', receipt);

                const event = receipt.events.find(e => e.event === 'InvoiceCreated');
                if (event) {
                    const [tokenId, amount, issuer, recipient] = event.args;
                    document.getElementById('small-business-result').textContent = `Invoice created: Token ID ${tokenId}, Amount ${formatRand(ethToRand(amount))}, Recipient ${recipient}`;
                } else {
                    document.getElementById('small-business-result').textContent = `Invoice created on Amoy. Transaction hash: ${receipt.transactionHash}`;
                }
                updateDashboards();
            } catch (error) {
                console.error('Error creating invoice on Amoy:', error);
                document.getElementById('small-business-result').textContent = 'Failed to create invoice on Amoy. See console for details.';
            }
        }

        async function payInvoice(tokenId, amount) {
            try {
                console.log(`Attempting to pay invoice on Amoy. Token ID: ${tokenId}, Amount: ${ethers.utils.formatEther(amount)} MATIC`);
                
                const gasPrice = await getGasPrice();
                const estimatedGas = await contract.estimateGas.payInvoice(tokenId, { value: amount });
                const gasLimit = estimatedGas.mul(120).div(100); // 20% buffer
                
                const tx = await contract.payInvoice(tokenId, { 
                    value: amount,
                    gasPrice: gasPrice,
                    gasLimit: gasLimit
                });
                console.log('Transaction sent, waiting for confirmation...');
                const receipt = await tx.wait();
                console.log('Invoice paid successfully on Amoy', receipt);
                document.getElementById('big-business-result').textContent = 'Invoice paid successfully on Amoy!';
                updateDashboards();
            } catch (error) {
                console.error('Error paying invoice on Amoy:', error);
                document.getElementById('big-business-result').textContent = `Failed to pay invoice on Amoy: ${error.message}`;
            }
        }

        async function listInvoiceForSale(tokenId) {
            try {
                const salePrice = prompt("Enter the sale price in Rands:");
                if (salePrice === null) return;
                const salePriceWei = randToEth(salePrice);
                
                console.log(`Attempting to list invoice for sale on Amoy. Token ID: ${tokenId}, Sale Price: ${ethers.utils.formatEther(salePriceWei)} MATIC`);

                const gasPrice = await getGasPrice();
                const tx = await contract.listInvoiceForSale(tokenId, salePriceWei, { gasPrice });
                console.log('Transaction sent, waiting for confirmation...');
                const receipt = await tx.wait();
                console.log('Invoice listed for sale successfully on Amoy', receipt);
                document.getElementById('small-business-result').textContent = 'Invoice listed for sale successfully on Amoy!';
                updateDashboards();
            } catch (error) {
                console.error('Error listing invoice for sale on Amoy:', error);
                document.getElementById('small-business-result').textContent = `Failed to list invoice for sale on Amoy: ${error.message}`;
            }
        }

        async function buyInvoice(tokenId, price) {
            try {
                console.log(`Attempting to buy invoice on Amoy. Token ID: ${tokenId}, Price: ${ethers.utils.formatEther(price)} MATIC`);
                
                const gasPrice = await getGasPrice();
                const tx = await contract.buyInvoice(tokenId, { value: price, gasPrice });
                console.log('Transaction sent, waiting for confirmation...');
                const receipt = await tx.wait();
                console.log('Invoice bought successfully on Amoy', receipt);
                document.getElementById('investor-result').textContent = 'Invoice bought successfully on Amoy!';
                updateDashboards();
            } catch (error) {
                console.error('Error buying invoice on Amoy:', error);
                document.getElementById('investor-result').textContent = `Failed to buy invoice on Amoy: ${error.message}`;
            }
        }

        function truncateAddress(address) {
            return `${address.slice(0, 6)}...${address.slice(-4)}`;
        }

        function clearLogAndReset() {
            console.clear();
            console.log('Logs cleared and UI reset');

            document.getElementById('small-business-result').textContent = '';
            document.getElementById('big-business-result').textContent = '';
            document.getElementById('investor-result').textContent = '';

            document.getElementById('smallBusinessTable').innerHTML = '';
            document.getElementById('bigBusinessTable').innerHTML = '';
            document.getElementById('investorTable').innerHTML = '';

            contract = null;
            signer = null;
        }

        window.addEventListener('load', clearLogAndReset);
    </script>
</body>
</html>
